---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

const pageTitle = "Programming Tutorials by Rasul Kireev";
const pageDescription = "Learn web development, Django, Python, and more through my comprehensive programming tutorials. Step-by-step guides covering Django projects, Python development, and web technologies.";
const pageKeywords = "programming tutorials, Django tutorials, Python tutorials, web development, coding guides, Django projects, Python development, programming education, Rasul Kireev";

const allTutorials = await getCollection('tutorials');

// Sort tutorials by date
allTutorials.sort((a, b) => b.data.dateUpdated.valueOf() - a.data.dateUpdated.valueOf());

// Get unique tags from all tutorials
const allTags = [...new Set(allTutorials.flatMap(tutorial => tutorial.data.tags || []))].sort();

// Get the selected tags from URL params
const selectedTags = Astro.url.searchParams.get('tags')?.split(',').filter(Boolean) || [];

// Filter tutorials if tags are selected
const filteredTutorials = selectedTags.length > 0
  ? allTutorials.filter(tutorial =>
      tutorial.data.tags?.some(tag => selectedTags.includes(tag))
    )
  : allTutorials;
---

<BaseLayout
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  pageKeywords={pageKeywords}
>
  <div class="mb-4">
    <button
      id="toggleTags"
      class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
    >
      Filter by tags
    </button>

    <div id="tagContainer" class="hidden mt-4 space-y-2">
      <div class="flex flex-wrap gap-2">
        {allTags.map(tag => (
          <button
            class="px-3 py-1 text-sm text-gray-700 bg-white rounded-full hover:bg-gray-50 tag-pill"
            data-tag={tag}
          >
            {tag}
          </button>
        ))}
      </div>
    </div>
  </div>

  {filteredTutorials.map(p => (
    <div class="mb-1 tutorial-item" data-tags={p.data.tags?.join(',')}>
      <a
        href={"/" + p.slug}
        class="flex flex-row items-center p-1 text-xl text-gray-900 border-0 rounded-lg hover:bg-gray-200"
        itemprop="blogPost"
        itemscope
        itemtype="http://schema.org/BlogPosting"
      >
        <Image
          src={p.data.icon}
          width="50"
          height="50"
          alt={p.data.title}
          class="self-start inline w-auto h-16 p-2 mr-4 align-middle"
          itemprop="image"
        />

        <div>
          <p class="text-sm md:text-lg">{ p.data.title }</p>
          <p class="m-0 text-xs text-gray-600" itemprop="headline">{ p.data.description }</p>
        </div>
      </a>
    </div>
  ))}
</BaseLayout>

<script>
  const toggleButton = document.getElementById('toggleTags');
  const tagContainer = document.getElementById('tagContainer');
  const tagPills = document.querySelectorAll('.tag-pill');
  const tutorialItems = document.querySelectorAll('.tutorial-item');

  // Toggle tag container visibility
  toggleButton?.addEventListener('click', () => {
    tagContainer?.classList.toggle('hidden');
  });

  // Handle tag selection
  tagPills.forEach(pill => {
    pill.addEventListener('click', () => {
      // Toggle visual state
      pill.classList.toggle('selected');
      pill.classList.toggle('bg-gray-100');
      pill.classList.toggle('border');
      pill.classList.toggle('border-blue-500');

      // Get all selected tags
      const selectedTags = Array.from(document.querySelectorAll('.tag-pill.selected'))
        .map(el => el.getAttribute('data-tag'))
        .filter(Boolean);

      // Update URL without page reload
      const newUrl = new URL(window.location.href);
      if (selectedTags.length > 0) {
        newUrl.searchParams.set('tags', selectedTags.join(','));
      } else {
        newUrl.searchParams.delete('tags');
      }
      window.history.pushState({}, '', newUrl);

      // Filter tutorials client-side
      filterTutorials(selectedTags);
    });

    // Set initial selected state based on URL params
    const currentTags = new URLSearchParams(window.location.search).get('tags')?.split(',').filter(Boolean) || [];
    if (currentTags.includes(pill.getAttribute('data-tag'))) {
      pill.classList.add('selected', 'bg-gray-100', 'border', 'border-blue-500');
    }
  });

  function filterTutorials(selectedTags) {
    console.log('Filtering with tags:', selectedTags); // Debug log

    tutorialItems.forEach(tutorial => {
      const tutorialTags = tutorial.getAttribute('data-tags')?.split(',').filter(Boolean) || [];
      console.log('Tutorial tags:', tutorialTags); // Debug log

      const shouldShow = selectedTags.length === 0 ||
        selectedTags.some(tag => tutorialTags.includes(tag));

      console.log('Should show:', shouldShow); // Debug log
      tutorial.style.display = shouldShow ? '' : 'none';
    });
  }

  // Initial filter on page load
  const initialTags = new URLSearchParams(window.location.search).get('tags')?.split(',').filter(Boolean) || [];
  if (initialTags.length > 0) {
    filterTutorials(initialTags);
  }
</script>
